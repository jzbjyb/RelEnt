<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Relation Hierarchy</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <style>
    .wrong {
      color: orangered;
    }
    .correct {
      color: green;
    }
    .relation {
      cursor: pointer;
    }
  </style>
</head>
<body ng-app="app" ng-controller="DemoCtrl">
  <!--
  <div id="rel_hier">
    <ul>
      <li>Root node 1
        <ul>
          <li id="child_node_1">Child node 1</li>
          <li>Child node 2</li>
        </ul>
      </li>
      <li>Root node 2</li>
    </ul>
    <ul>
      <li ng-repeat="category in categories" ng-include="'RelHier'"></li>
    </ul>
  </div>
  -->

  <div class="container-fluid">
    <div class="row">
      <div class="col-sm">
        <div js-tree="treeConfig" ng-model="treeData" should-apply="ignoreModelChanges()" tree="treeInstance"  tree-events-obj="treeEventsObj"></div>
      </div>
      <div class="col-sm">
        <ul class="list-group">
          <li class="list-group-item" ng-repeat="rel in testTreeData">
            <div>
              <span ng-click="loadHeadTail(rel.id)" class="relation" ng-class="{wrong: rel.parent != rel.pred_parent, correct: rel.parent == rel.pred_parent}">{{ rel.text }}</span>
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm" ng-click="locateParent(rel.parent)">real parent</button>
            <button type="button" class="btn btn-outline-primary btn-sm" ng-click="locateParent(rel.pred_parent)">predicted parent</button>
          </li>
        </ul>
      </div>
      <div class="col-sm">
        <div id="head_tail">
          <ul>
            <li ng-repeat="ht in headTail">
              {{ ht }}
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.js"></script>-->
  <script src="node_modules/jquery/dist/jquery.js"></script>
  <script src="node_modules/jstree/dist/jstree.js"></script>
  <script src="node_modules/angular/angular.js"></script>
  <script src="node_modules/underscore/underscore.js"></script>
  <script src="node_modules/ng-js-tree/dist/ngJsTree.js"></script>
  <script src="data/tree_data.js"></script>
  <script src="data/test_tree_data.js"></script>
  <script src="data/head_tail.js"></script>
  <script type="text/ng-template" id="RelHier">
    {{ category.title }}
    <ul ng-if="category.categories">
      <li ng-repeat="category in category.categories" ng-include="'RelHier'">
      </li>
    </ul>
  </script>
  <script>
    function readJSON(path) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', path, true);
      xhr.responseType = 'blob';
      xhr.onload = function(e) {
        if (this.status == 200) {
          var file = new File([this.response], 'temp');
          var fileReader = new FileReader();
          fileReader.addEventListener('load', function(){
            //do stuff with fileReader.result
          });
          fileReader.readAsText(file);
        }
      };
      xhr.send();
    }

    // original jsTree
    $(function () {
      $('#rel_hier').jstree();
      $('#rel_hier').on("changed.jstree", function (e, data) {
        console.log(data.selected);
      });
    });

    // angular controller
    var app = angular.module('app', ['ngJsTree']);
    app.controller('DemoCtrl', function ($scope) {
      $scope.categories = [
        {
          title: 'Computers',
          categories: [
            {
              title: 'Laptops',
              categories: [
                {
                  title: 'Ultrabooks'
                },
                {
                  title: 'Macbooks'
                }
              ]
            },

            {
              title: 'Desktops'
            },

            {
              title: 'Tablets',
              categories: [
                {
                  title: 'Apple'
                },
                {
                  title: 'Android'
                }
              ]
            }
          ]
        },

        {
          title: 'Printers'
        }
      ];

      $('#rel_hier').on("changed.jstree", function (e, data) {
        console.log(data);
      });

      $scope.treeConfig = {
        core : {
          multiple: false,
          animation: true,
          error: function(error) {
            $log.error('treeCtrl: error from js tree - ' + angular.toJson(error));
          },
          check_callback: true,
          worker: true
        },
        types: {
          default: {
            icon: 'glyphicon glyphicon-flash'
          },
          star: {
            icon: 'glyphicon glyphicon-star'
          },
          cloud: {
            icon: 'glyphicon glyphicon-cloud'
          }
        },
        version: 1,
        plugins: ['types','checkbox']
      };

      // sample data
      $scope.treeData = [
        { id : '1', parent : '#', text : 'Simple root node', state: {opened: false} },
        { id : '2', parent : '#', text : 'Root node 2', state: {opened: false, selected: true} },
        { id : '3', parent : '2', text : 'Child 1', state: {opened: false} },
        { id : '4', parent : '2', text : 'Child 2' , state: {opened: false}}
      ];
      $scope.treeData = [];
      angular.copy(treeData, $scope.treeData);
      $scope.testTreeData = [];
      angular.copy(testTreeData, $scope.testTreeData);

      //$.getJSON("data/tree_data.json", function(json) {
      //  $scope.treeData = json;
      //});

      // sample data
      $scope.healTailDict = {
        "1": [['1', '2']],
        "2": [['2', '3'], ['4', '5']]
      };
      $scope.healTailDict = healTailDict;

      $scope.locateParent = function(real_parent, pred_parent) {
        $scope.treeData = [];
        angular.copy(treeData, $scope.treeData);
        var item = _.findWhere($scope.treeData, {'id': real_parent});
        if (item != undefined) item.state = {selected: true, opened: false};
        $scope.treeConfig.version++;
      };

      $scope.loadHeadTail = function(id) {
        $scope.headTail = $scope.healTailDict[id];
      };

      $scope.treeEventsObj = {
        'select_node': selectNodeCB
      };

      function selectNodeCB(node, selected, event) {
        $scope.loadHeadTail(selected.node.id);
        console.log(selected);
      };
    });
  </script>
</body>
</html>